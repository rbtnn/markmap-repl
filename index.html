<!doctype html>
<html lang="en">
  <head>
    <title>Markmap REPL</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/d3@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.7.11/dist/browser/view.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.7.11/dist/browser/transform.min.js"></script>
<style>
body {
  background-color: rgb(39 39 42);
  color: rgb(255 255 255);
  display: grid;
  grid-template-rows: 50px calc(98vh - 50px);
  grid-template-columns: 49vw 49vw;
  margin: 0;
}

.tabs {
  grid-column: 1 / span 2;
  grid-row: 1;
  display: flex;
  background: #2e2e2e;
  align-items: center;
}

.tab {
  display: flex;
  align-items: center;
  background: #2e2e2e;
}

.tab-btn {
  padding: 8px 12px;
  cursor: pointer;
  background: transparent;
  border: none;
  color: #d4d4d4;
}

.tab-btn.active {
  background: #444;
}

.close-btn {
  padding: 8px;
  cursor: pointer;
  background: transparent;
  border: none;
  color: #ff6b6b;
}

.add-btn {
  margin-left: auto;
  padding: 8px 16px;
  cursor: pointer;
  background: #1e1e1e;
  border: none;
  color: #00ff95;
}

.textarea-container {
  display: flex;
  width: 49vw;
  grid-row: 2;
  grid-column: 1;
}

.textarea-container textarea {
  flex: 1;
  resize: none;
  box-sizing: border-box;
  font-family: monospace;
  font-size: 16px;
  padding: 10px;
  background-color: #1e1e1e;
  color: #d4d4d4;
  border: none;
  outline: none; 
}

.svg-container {
  display: flex;
  width: 49vw;
  grid-row: 2;
  grid-column: 2;
}

svg {
  flex: 1;
}
</style>
  </head>
  <body>
    <div class="tabs" id="tabs">
      <button class="add-btn" id="addTab">＋</button>
    </div>
    <div class="textarea-container">
      <textarea id="md"></textarea>
    </div>
    <div class="svg-container">
      <svg id="mindmap"></svg>
    </div>

<script>
  const text = document.getElementById('md');
  const svg = document.getElementById('mindmap');
  const tabsEl = document.getElementById('tabs');
  const addBtn = document.getElementById('addTab');

  let mm = null;
  let currentTab = null;

  const STORAGE_TABS = "markmap-tabs";

  function storageKey(tabId) {
    return "markmap-md-" + tabId;
  }

  function save(tabId, value) {
    localStorage.setItem(storageKey(tabId), value);
  }

  function load(tabId) {
    return localStorage.getItem(storageKey(tabId));
  }

  function saveTabs(tabs) {
    localStorage.setItem(STORAGE_TABS, JSON.stringify(tabs));
  }

  function loadTabs() {
    const saved = localStorage.getItem(STORAGE_TABS);
    return saved ? JSON.parse(saved) : [];
  }

  function render() {
    const data = markmap.transform(text.value);
    if (!mm) {
      mm = markmap.Markmap.create(svg, null, data);
    } else {
      mm.setData(data);
      mm.fit();
    }
    if (currentTab) {
      save(currentTab, text.value);
    }
  }

  function switchTab(tabId) {
    if (currentTab) {
      save(currentTab, text.value);
    }
    currentTab = tabId;

    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.tab-btn[data-id="${tabId}"]`).classList.add('active');

    const saved = load(tabId);
    text.value = saved || `# ${tabId}\n\n- new note`;
    render();
  }

  function deleteTab(tabId) {
    let tabs = loadTabs();
    if (tabs.length <= 1) {
      return;
    }
    localStorage.removeItem(storageKey(tabId));
    tabs = tabs.filter(t => t.id !== tabId);
    saveTabs(tabs);

    const tabEl = document.querySelector(`.tab[data-id="${tabId}"]`);
    if (tabEl) tabEl.remove();

    if (currentTab === tabId) {
      if (tabs.length > 0) {
        switchTab(tabs[0].id);
      } else {
        text.value = "";
        svg.innerHTML = "";
        currentTab = null;
      }
    }

    updateCloseButtons();
  }

  function createTab(name) {
    const tabId = "tab-" + Date.now();

    const tab = document.createElement("div");
    tab.className = "tab";
    tab.dataset.id = tabId;

    const btn = document.createElement("button");
    btn.className = "tab-btn";
    btn.textContent = name;
    btn.dataset.id = tabId;
    btn.addEventListener("click", () => switchTab(tabId));

    const close = document.createElement("button");
    close.className = "close-btn";
    close.textContent = "×";
    close.addEventListener("click", (e) => {
      e.stopPropagation();
      deleteTab(tabId);
    });

    tab.appendChild(btn);
    tab.appendChild(close);
    tabsEl.insertBefore(tab, addBtn);

    const tabs = loadTabs();
    tabs.push({ id: tabId, name });
    saveTabs(tabs);

    switchTab(tabId);
    updateCloseButtons();
  }

  function updateCloseButtons() {
    const tabs = loadTabs();
    const closeBtns = document.querySelectorAll('.close-btn');
    if (tabs.length <= 1) {
      closeBtns.forEach(btn => btn.style.display = "none");
    } else {
      closeBtns.forEach(btn => btn.style.display = "inline");
    }
  }

  function init() {
    const tabs = loadTabs();
    if (tabs.length === 0) {
      createTab("Tab 1");
    } else {
      tabs.forEach(tabData => {
        const tab = document.createElement("div");
        tab.className = "tab";
        tab.dataset.id = tabData.id;

        const btn = document.createElement("button");
        btn.className = "tab-btn";
        btn.textContent = tabData.name;
        btn.dataset.id = tabData.id;
        btn.addEventListener("click", () => switchTab(tabData.id));

        const close = document.createElement("button");
        close.className = "close-btn";
        close.textContent = "×";
        close.addEventListener("click", (e) => {
          e.stopPropagation();
          deleteTab(tabData.id);
        });

        tab.appendChild(btn);
        tab.appendChild(close);
        tabsEl.insertBefore(tab, addBtn);
      });
      switchTab(tabs[0].id);
      updateCloseButtons();
    }
  }

  text.addEventListener('input', render);
  addBtn.addEventListener('click', () => {
    const name = prompt("新しいタブの名前を入力:", "New Tab");
    if (name) createTab(name);
  });

  init();
</script>
  </body>
</html>
